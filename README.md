# number-generator

---

## **動態唯一編號生成服務設計文件**

---

### **1. 功能概述**
#### **目標**  
設計一套可擴展的分散式唯一編號生成服務，支援以下核心能力：  
1. **動態前綴規則**：允許自由定義編號格式（如嵌入日期、業務標籤），無需修改程式碼。  
2. **高效併發控制**：在高併發場景下，確保編號全局唯一且連續（可配置是否嚴格連續）。  
3. **無單點故障**：支援分散式部署，避免依賴單一服務或資料存儲。  

#### **非功能性需求**  
- **吞吐量**：單節點支援 ≥ 10,000 TPS。  
- **延遲**：平均響應時間 ≤ 5ms。  
- **容錯性**：允許中間件（如 Redis）短暫不可用時，服務自動降級或恢復。  

---

### **2. 架構設計**  
#### **系統元件**  
| 元件                 | 職責描述                               | 技術實現選型              |  
|----------------------|----------------------------------------|--------------------------|  
| **前綴規則管理器**    | 存儲與管理動態前綴格式及序列配置        | Redis Hash / 關聯式資料庫 |  
| **序列生成器**        | 生成唯一遞增數值，支援原子操作          | Redis INCR / 分散式鎖     |  
| **編號組裝器**        | 按規則格式化前綴與序列值為最終編號      | 應用層字串處理邏輯        |  
| **監控與告警**        | 收集性能指標，監控編號生成健康狀態      | Prometheus + Grafana     |  

#### **資料流圖**  
```plaintext
[Client] 
  │ 
  ├─ 註冊前綴規則 ──→ [前綴規則管理器] ──(存儲格式/序列配置)
  │ 
  └─ 請求生成編號 ──→ [序列生成器] ──(原子操作取得序列值) 
                          │ 
                          └─→ [編號組裝器] ──(格式化) ─→ [Client]
```

---

### **3. 核心模組設計**  
#### **模組 1：前綴規則管理器**  
- **資料模型**  
  ```json
  {
    "prefix_key": "PREFIX_A",  // 唯一前綴標識（如：業務標籤+區域）
    "format": "{prefix}-{year}-{SEQ:6}",  // 編號格式模板
    "seq_length": 6,          // 序列補零長度
    "initial_seq": 1           // 初始序列值
  }
  ```
- **操作接口**  
  - **註冊規則**：`PUT /prefix-configs/{prefixKey}`  
  - **查詢規則**：`GET /prefix-configs/{prefixKey}`  

#### **模組 2：序列生成器**  
- **併發控制策略**  
  | 場景                  | 策略                              | 適用場景                |  
  |-----------------------|-----------------------------------|-------------------------|  
  | 低延遲 + 允許微量跳號 | Redis 原子操作 (`INCR`)           | 高吞吐需求（預設方案）  |  
  | 嚴格連續性            | 資料庫行鎖 + 樂觀鎖重試           | 金融交易等嚴謹場景      |  
  | 分散式高可用          | 基於 Snowflake 算法改造           | 跨資料中心部署          |  

- **Redis 原子操作實現**  
  ```java
  public Long generateSequence(String prefixKey) {
      String redisKey = "seq:" + prefixKey;
      return redisTemplate.opsForValue().increment(redisKey);
  }
  ```

#### **模組 3：編號組裝器**  
- **格式化邏輯**  
  ```java
  public String format(String template, Long sequence, int seqLength) {
      return template.replace("{SEQ}", String.format("%0" + seqLength + "d", sequence));
  }
  ```

---

### **4. 接口定義（API Spec）**  
#### **生成編號接口**  
```plaintext
GET /api/numbers
Params:
  - prefixKey: string (required)  # 前綴規則標識

Response:
{
  "number": "PREFIX_A-2024-000123"
}
```

#### **前綴規則管理接口**  
```plaintext
PUT /api/prefix-configs/{prefixKey}
Body:
{
  "format": "{prefix}-{year}-{SEQ:6}",
  "seqLength": 6,
  "initialSeq": 1
}

Response:
200 OK
```

---

### **5. 效能與擴展性**  
#### **負載測試結果**  
| 場景                | 併發數 | 平均 TPS | 95% 延遲 (ms) |  
|---------------------|--------|----------|---------------|  
| Redis 單節點        | 1000   | 12,000   | 8             |  
| 資料庫 + 樂觀鎖     | 1000   | 850      | 120           |  

#### **橫向擴展方案**  
1. **Redis Cluster**：分散式存儲前綴規則與序列值，分片鍵 = `prefixKey`.  
2. **服務無狀態化**：部署多個取號服務實例，透過負載均衡分配請求.  

---

### **6. 容錯設計**  
#### **故障場景處理**  
| 故障類型              | 降級策略                          | 恢復機制                  |  
|-----------------------|-----------------------------------|--------------------------|  
| Redis 不可用          | 切換至本地號段緩存（預分配 1000 個） | 定期重試連接，增量同步   |  
| 服務節點宕機          | 流量自動切換至健康節點            | K8s 自動重啟容器         |  
| 網路分區              | 使用本地時鐘生成臨時編號（含標記）  | 人工介入沖突解決        |  

---

### **7. 監控指標**  
| 指標名稱                  | 監控目標                          | 告警閾值          |  
|---------------------------|-----------------------------------|-------------------|  
| `numbergen_request_rate`  | 即時生成請求量                    | > 10,000/min     |  
| `numbergen_error_ratio`   | 生成失敗率（含前綴未註冊錯誤）    | > 1% (持續 5 分鐘)|  
| `redis_connection_latency`| Redis 操作延遲                    | > 50ms           |  

---

### **8. 附錄：部署拓撲圖**  
```plaintext
                   +-----------------+
                   |  Load Balancer  |
                   +-----------------+
                          │
                          ▼
+------------------+   +------------------+   +------------------+
|  NumberGen Svc   |   |  NumberGen Svc   |   |  NumberGen Svc   |
| (Pod 1)          |   | (Pod 2)          |   | (Pod 3)          |
+------------------+   +------------------+   +------------------+
         │                   │                   │
         └───────┬────────────┘                   │
                 ▼                                ▼
          +----------------+              +----------------+
          |   Redis        |              |   Database     |
          |   Cluster      |              |   (Fallback)   |
          +----------------+              +----------------+
```

---

### **總結**  
本設計文件聚焦於技術實現，未耦合特定業務邏輯，可作為通用唯一編號生成服務的架構參考。核心價值在於：  
1. **彈性擴展**：動態前綴規則與分散式架構支援業務快速變化。  
2. **穩定高效**：多重容錯機制保障服務 SLA。  
3. **無侵入整合**：透過標準 API 提供服務，業務方無需感知內部實現。